---
title: 'Final Project'
author: "Yigit Tahmisoglu"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Github repository: <https://github.com/tahmisoglu-yigit/R_Project.git>

Requirements:
1. 1-page executive summary (can include 1 graph or image) \\
4. Data exploration, questions you tried to answer, interesting things. This should be similar to the data exploration in R for Data Science (Chapter 7) and most other parts of the book. No hard results needed. (3-5 pages)\\
5. Code: Include one piece of code that you describe in some detail what it does. Pick your favorite graph or table, and explain the choices you made and what each step does. A pipeline (\|\>) of 4 to 7 steps is sufficient.The goal is to have you write and explain code.

## Summary of the raw data set

The data set is the one I plan to use for my masters thesis. It is a cross-sectional survey data from the Demographic and Health Surveys for Turkey from the year 2018, which is a representative household survey providing detailed information on birth recodes and individual records for women of each household for developing countries. The program conducted its first survey in Turkey in 1993 and it has been conducted once in every five years. The dataset provides nationally representative individual and household level categorical data on household characteristics, living conditions, respondent background characteristics (e.g. fertility rates, education levels, child mortality rates, employment status), child health, family planning, domestic violence to name but a few. In this analysis, I will try to show the relationship between age at first childbirth and different variables such as education, type of residence, parental education, employment status, consent for marriage etc.

### Explain how you cleaned the data, or if it was clean, how you ensured that it was. Clearly mention any R scripts that did the checking. (It should be automated, that means no "I printed it a few times to the screen and stared at it.") (1-2 pages, less if data was clean) :

```{r include=FALSE}
# install.packages("rio")
library(rio)
library(dplyr)
library(tidyverse)
library(ggplot2)
```

```{r include=FALSE}
dropbox <- "https://www.dropbox.com/s/zemcx6rqxsxu9ht/TRIR71.csv?dl=1"
df <- import(dropbox, format = "csv")
```

Variable names are not descriptive. But taking the DHS Manual as reference (https://dhsprogram.com/pubs/pdf/DHSG4/Recode7_Map_31Aug2018_DHSG4.pdf), we can rename the variable of interests to make further analyses easier.

```{r Rename variables, echo=TRUE, message=FALSE, warning=FALSE}
fullsample <- df |>
  rename(birth_month=V009,
         birth_year=V010,
         age = V012,
         age_5bin = V013,
         region = V024,
         residence = V025,
         residence_childhood=V103,
         educ_level=V106,
         educ = V133,
         age_at_birth = V212,
         educ_mother = S119,
         educ_father = S121
         )

# unique(fullsample$region)
# unique(fullsample$residence)
# unique(fullsample$educ_level)
# unique(fullsample$age_5bin)

# Recoding unique values of categorical variables
fullsample$region <- recode(fullsample$region,
                     "1" = "West",
                     "2" = "South",
                     "3" = "Central",
                     "4" = "North",
                     "5" = "East")

fullsample$residence <- recode(fullsample$residence,
                    "1" = "Urban", 
                    "2" = "Rural")

fullsample$educ_level <- recode(fullsample$educ_level,
                    "0" = "No education", 
                    "1" = "Primary", 
                    "2" = "Secondary", 
                    "3" = "Higher")
fullsample$age_5bin <- recode(fullsample$age_5bin,
                     "1" = "15-19",
                     "2" = "20-24",
                     "3" = "25-29",
                     "4" = "30-34",
                     "5" = "35-39",
                     "6" = "40-44",
                     "7" = "45-49")

# Create binary variable representing whether person gave birth as a teenager:
fullsample <- fullsample |>
  drop_na(age_at_birth) |>
  mutate(teenbirth = ifelse(age_at_birth < 18, 1, 0))
# Create birthdate by joining year and month in yyyymm format 
fullsample$birthdate <- sprintf("%04d%02d", fullsample$birth_year, fullsample$birth_month)
# Filter the fullsample to 
subsample <- subset(fullsample, birthdate >= 199201 & birthdate <= 200512 & birth_month)
# Assign treatment status, which is whether an individual had to go to school under new CSL policy of 12 or not.
subsample$treatment <- ifelse(subsample$birthdate >= 199801, 1, 0)






```

## Descriptive stats:

```{r Plots1}

# Table1: Percentage of Urban and Rural Residents by Education Level
(table <- table( fullsample$residence, fullsample$educ_level))
(table1 <- prop.table(table, margin = 2) * 100)
# Create the bar chart
barplot(table1, beside=TRUE, 
        col=c("blue","grey"), 
        xlab="Education Level", ylab="Percentage", 
        main="Percentage of Urban and Rural Residents by Education Level",
        legend=c("Rural","Urban"))

# Plot the mean age at first birth for each region
mean_age <- aggregate(age_at_birth ~ region, data = fullsample, FUN = mean)
ggplot(mean_age, aes(x = region, y = age_at_birth)) +
  geom_bar(stat = "identity") +
  ylim(0, max(fullsample$age_at_birth)) +
  labs(x = "Region", y = "Mean Age at First Birth", title = "Mean Age at First Birth by Region")
unique(fullsample$region)

# Distribution of teenage birth by region
teenbirth_count <- aggregate(teenbirth ~ region, data = fullsample, FUN = function(x) c(teenbirth=sum(x), not_teenbirth=sum(!x)))
teenbirth_perc <- aggregate(teenbirth ~ region, data = fullsample, FUN = function(x)
  c(teenbirth=sum(x)/length(x)*100, 
  not_teenbirth=sum(!x)/length(x)*100))

df2<- fullsample |>
    group_by(age_at_birth) |>
    summarize(mean_educ = mean(educ, na.rm = TRUE)) |>
    ungroup()

model1 <- lm(age_at_birth ~ educ_level, data = fullsample)
summary(model1)
plot(model1$fitted.values, model1$residuals, xlab = "Fitted Values", ylab = "Residuals")



```

# Plotting the relationships:

```{r Plots, echo=FALSE, message=FALSE, warning=FALSE}

## 1. Education level and residence type
ggplot(fullsample, aes(x = educ_level, fill = residence)) +
  geom_bar()

## 2. Age at first birth histogram
(ggplot(data = fullsample,
            mapping = aes(x = age_at_birth) ) + geom_histogram()+
            scale_x_continuous(breaks = unique(fullsample$age_at_birth)))
ggsave("age_firstbirth_hist.png", plot = p, width = 6, height = 4, dpi = 300)

## Average Age at First Birth by Years of Education
df2 <- fullsample %>%
  group_by(educ_level) %>%
  summarize(avg_age = mean(age_at_birth, na.rm=TRUE)) %>%
  ungroup() |>
  ggplot(mapping = aes(x = reorder(educ_level, avg_age), y = avg_age)) +
    geom_col(fill = "blue") +
    xlab("Education") +
    ylab("Average Age at First Birth") +
    ggtitle("Average Age at First Birth by Education")

## Average Age at First Birth by Each Level of Education
fullsample %>%
  ggplot(mapping = aes(x = age_at_birth)) +
    geom_histogram(binwidth = 1, color = "black", fill = "blue") +
    facet_wrap(~ educ_level, ncol = 2) +
    xlab("Age at First Birth") +
    ylab("Count") +
    ggtitle("Age at First Birth by Education Level")


## Years of education vs Mean age at first birth
df2<- fullsample |>
    group_by(educ) |>
    summarize(mean_age_birth = mean(age_at_birth, na.rm = TRUE)) |>
    ungroup()

ggplot(df2, aes(x = educ, y = mean_age_birth)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, level = 0.90) +
  labs(x = "Years of education", y = "Mean age at first birth")






# ## (not ideal) Education years and age at first birth
# by_age_at_birth <- group_by(fullsample, age_at_birth)
# avg_educ_by_age_at_first_birth <- summarise(
#   by_age_at_birth,
#   avgeduc = mean(educ, na.rm = TRUE))
# 
# avg_educ_by_age_at_first_birth$age_group <- cut(avg_educ_by_age_at_first_birth$age_at_birth, 
#                                                 breaks = seq(12, 49, by = 5), na.rm = TRUE)
# (ggplot(data = avg_educ_by_age_at_first_birth,
#         mapping = aes(y = avgeduc, x = age_group)) +
#         geom_point() +
#         labs(x = "Age at first birth", y = "Average education (in years)"))
# ggsave("educ_age.png", plot = p, width = 6, height = 4, dpi = 300)

```



## RDD
```{undefinedRDD}
library(foreign)
install.packages("lpdensity")
install.packages("rddensity")
install.packages("rdrobust")
install.packages("rdlocrand")
library(lpdensity)
library(rddensity)
library(rdrobust)
library(rdlocrand)

# X = continuous forcing/assignment variable (risk score);
# Z = threshold indicator (is risk score above/below 20%);
# T = treatment administered (statin prescription);
# C â‰¡ (O, U) = observed and unobserved covariates (social class etc)
# Y = continuous outcome (LDL cholesterol level).
??as.factor
Y = fullsample$teenbirth
X = fullsample$birthdate
T = fullsample$treatment
T_X = T*X


rdplot(Y, T, p =2, h=50,
       x.label="Distance", y.label = " ",
       x.lim = c(-50, 50),
       title = "Expenditure per capita, All Regions")


rdplot(Y, X, nbins = c(20,20), binselect = 'esmv', x.label = 'Running Variable', y.label = 'Outcome',
       title = '', y.lim = c(0,25))


fullsample$birthdate <- as.Date(paste(fullsample$birth_year, fullsample$birth_month, "01", sep = "-"))
fullsample$date_num <- as.numeric(fullsample$birthdate - as.Date("1970-01-01"))
fullsample$treatment <- ifelse(fullsample$birthdate > as.Date("1998-01-01"), 1, 0)
cutoff_date <- as.Date("1998-01-01")
cutoff_date_num <- as.numeric(cutoff_date - as.Date("1970-01-01"))



ggplot(fullsample, aes(x = date_num, y = teenbirth, group = treatment, color = factor(treatment))) +
  geom_smooth(aes(weight = ifelse(date_num > cutoff_date, treatment, 1 - treatment)),
              method = "loess", se = FALSE, span = 0.2) +
  geom_vline(xintercept = cutoff_date_num, linetype = "dashed") +
  scale_x_continuous(limits = c(min(fullsample$date_num), max(fullsample$date_num))) +
  scale_y_continuous(limits = c(0, 1), expand = c(0, 0.1), breaks = c(0, 1), labels = c("No", "Yes")) +
  labs(x = "Date", y = "Teenbirth", color = "Treatment") +
  theme_classic()




# Convert the birthdate column to a character type
fullsample$birthdate <- as.character(fullsample$birthdate)
unique(fullsample$birthdate)

fullsample$cutoff <- as.numeric(fullsample$birth_month == 1 & fullsample$birth_year == 1998)

# Create a date object representing the cutoff point
cutoff_date <- as.Date("1998-01-01")

# Convert the birthdate column to a Date object
fullsample$birthdate <- as.Date(paste0(fullsample$birthdate, ".01"), format = "%Y.%m.%d")

# Create the treatment variable using the cutoff point
fullsample$treatment <- as.integer(fullsample$birthdate >= cutoff_date)


rdd_object <- rdd_data(y = fullsample$teenbirth, x = fullsample$treatment, cutpoint = cutoff_date)





# install.packages("KernSmooth")
# library(KernSmooth)
# IKbandwidth(treatment, teenbirth, cutpoint = NULL, verbose = FALSE, kernel = "triangular")

install.packages("rddtools")
library(rddtools)

# Create a new variable representing the cutoff date
# unique(fullsample$cutoff)
# subset(fullsample, birth_month == 1 & birth_year == 1998)
# class(fullsample$cutoff)

# Create a binary running variable

# Estimate the treatment effect using local linear regression
rdd <- rddtools::rdd_data(fullsample$treatment, fullsample$teenbirth, cutpoint = fullsample$cutoff, bw = "mserd")

# Plot the RDD with the estimated treatment effect
plot(rdd, est_method = "mserd")


```

```{r include=FALSE}
rmarkdown::render("FinalProject_v1.Rmd", output_format = "pdf_document")

```
